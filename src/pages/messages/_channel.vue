<template>
  <div :key="$route.fullPath" class="row">
    <div class="col-md-4 order-md-2">
      <chat-panel
        v-if="chat"
        :chat="chat"
        :is-moderator="isModerator"
        :initial-channel.sync="channel"
      />
      <pm-panel v-else :initial-channel.sync="channel" />
    </div>
    <div class="col-md-8 order-md-1">
      <message-compose v-if="canPost" v-model="message" :channel="channel" />
      <div class="card">
        <div class="card-body">
          <message-list
            :data="data"
            :option="options"
            :refresh-date="date"
            :is-moderator="isModerator"
            :channel-type="channel.type"
            :last-read-message-id="data.meta.marker && data.meta.marker.id"
          />
        </div>
      </div>
    </div>
  </div>
</template>

<script lang="ts">
import Vue from 'vue'
import { userIdIsSimpleUser } from '~/util/channel'
import MessageList from '~/components/MessageList.vue'
import MessageCompose from '~/components/MessageCompose.vue'
import ChatPanel from '~/components/ChatPanel.vue'
import PmPanel from '~/components/PmPanel.vue'
import markAsRead from '~/assets/ts/mark-as-read'
import { getRSSLink, deletedUser, findChatValueRaw } from '~/assets/ts/util'
import { ChatRoomSettings } from '~/models/raw/raw/chat-room-settings'
import { Channel } from '~/models/channel'
import { User } from '~/models/user'
import refreshAfterAdded from '~/assets/ts/refresh-after-added'

export default Vue.extend({
  components: {
    MessageList,
    MessageCompose,
    ChatPanel,
    PmPanel,
  },
  mixins: [refreshAfterAdded, markAsRead],
  validate({ params: { channel } }) {
    return /^\d+$/.test(channel)
  },
  async asyncData({ app: { $axios, $resource }, params, error }) {
    const options = {
      include_deleted: 1,
    }
    const messagesPromise = $resource({ options })
    const channelPromise = $axios.$get(`/channels/${params.channel}`, {
      params: {
        include_limited_users: 1,
        include_channel_raw: 1,
      },
    })
    try {
      const [data, { data: channel }] = await Promise.all([
        messagesPromise,
        channelPromise,
      ])
      channel.owner = {
        ...deletedUser,
        ...channel.owner,
      }
      return {
        data,
        channel,
        options,
      }
    } catch (e) {
      const { code, error_message } = e.response.data.meta
      return error({
        statusCode: code,
        message: error_message,
      })
    }
  },
  data() {
    return {
      message: '',
      // TODO
      channel: null as Channel | null,
    }
  },
  computed: {
    chat(): ChatRoomSettings.Value | void {
      if (!this.channel) return
      return findChatValueRaw(this.channel)
    },
    user(): User | void {
      return this.$accessor.user
    },
    isModerator(): boolean {
      return (
        !!this.user &&
        !!this.channel &&
        ((this.channel.owner && this.user.id === this.channel.owner.id) ||
          !!this.channel.acl.full.user_ids
            .filter(userIdIsSimpleUser)
            .find((u) => !!this.user && u.id === this.user.id))
      )
    },
    isPM(): boolean {
      if (!this.channel) return false
      return this.channel.type === 'io.pnut.core.pm'
    },
    canPost(): boolean {
      if (!this.channel) return false
      return !!this.user && this.channel.acl.write.you
    },
  },
  watch: {
    '$route.fullPath': {
      handler() {
        this.$emit('updateNav', this.isPM)
      },
      immediate: true,
    },
  },
  mounted() {
    // TODO
    setTimeout(() => (this as any).markAsRead(), 1000)
  },
  head() {
    if (!this.channel || !this.channel.id) return {}
    // TODO
    const id = (this as any).channel.id
    const link = [
      getRSSLink(`https://api.pnut.io/v0/feed/rss/channels/${id}/messages`),
    ]
    return {
      link,
    }
  },
})
</script>
<style scoped lang="scss">
@import '~assets/css/mixin';
.card {
  @include no-gutter-xs;
}
</style>
